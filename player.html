<!doctype html>
<html lang = "en">
   <head>
      <meta charset = "utf-8">
      <title>Wavesurfer Test</title>
      <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel = "stylesheet">
      <script src = "https://code.jquery.com/jquery-1.10.2.js"></script>
      <script src = "https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
      <script src = "https://unpkg.com/wavesurfer.js"></script>
      <!-- plugins -->
      <script src = "https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.playhead.js"></script>
      <!-- internals-->
      <script type = "text/javascript" src="js/helper.js"></script>
      <script type = "text/javascript" src="js/ws-player.js"></script>
   </head>
   
   <body>
      <table width="100%">
         <tr>
            <th width="46%">Deck 1</th>
            <th></th>
            <th width="46%">Deck 2</th>
          </tr>
          <tr>
            <td><div class="info"></div><div class="pos"></div></td>
            <td><input type="file" id="selector" accept=".mp3,.wav,.ogg" style="display: none;" multiple>
               <input type="button" value="File..." onclick="document.getElementById('selector').click();" /></td>
            <td><div class="info"></div><div class="pos"></div></td>
          </tr>
          <tr>
            <td><div class="deck"></div></td>
            <td><input type="button" id="urlOpen" value="Audius Track" /></td>
            <td><div class="deck"></div></td>
         </tr>
         <tr>
            <td><input type="button" class="playstop" onclick ="player[0].playPause();" value="Play " />
            <select class="selectOut" id="out1" style="display: none;"></select></td>
            <td></td>
            <td><input type="button" class="playstop" onclick ="player[1].playPause();;" value="Play " />
            <select class="selectOut" id="out2" style="display: none;"></select></td>
         </tr>
      </table>
      <table width="80%">
         <tr>
           <td>
           <select id="fileList" Size="20" style="width: 100%;" autofocus>
             <option value="tracks/1276388710">Rhea Silvia - Carbon Birds</option>
             <option value="tracks/629033148">Sebek & Rhea Silvia - Daedalus</option>
           </select>
           </td>
           <td><img id="cover" style="max-width:300px;"></img></td>
         </tr>
      </table>
      <pre id="log"></pre>
      <div id = "openDiag" title = "Add Audius Track">
      <label for="url">Enter URL or Embed-Code</label>
      <input type="url" id="SCurl" placeholder="https://discoveryprovider.audius.co/v1/tracks/" pattern="https://.*" size="35" required>
      </div>
   </body>
   <script type = "text/javascript">
      'use strict';
     var fileSelector = document.getElementById("selector"),
      out1 = document.getElementById("out1"),
      out2 = document.getElementById("out2"),
      fileList = document.getElementById("fileList"),
      pos = $('div[class="pos"]'),
      info = $('div[class="info"]'),
      deck = $('div[class="deck"]'),
      fileStore = [],
      player = [],
      blinker = false;

      $("#urlOpen").click(function() {
      ($("#openDiag").dialog("isOpen") == false) ? $(
        "#openDiag").dialog("open") : $("#openDiag").dialog("close") ;
      });
      $("#openDiag").dialog({autoOpen: false, width: 380,
      buttons: {
         Cancel: function() {
         $(this).dialog("close");},
         Add: function() {
         addURL($("#SCurl").val());
         $(this).dialog("close");}
      },
      close: function() {
         document.getElementById("SCurl").value = "";
      }});

      window.onload = function(){
         //initMIDI();
         initPlayers();
         //readTitles(addListEntry);
      }

      
   function addURL(newTrack){
      var nextID = 0;
      //var track = new Audio(`https://discoveryprovider.audius.co/v1/tracks/qGBBkOP/stream
      //var track = new Audio(`https://discoveryprovider.audius.co/v1/tracks/WgRdR6l/stream
      var track = new Audio(newTrack + `?app_name=AlphabeatPlayer`);
      if(player[0].isPlaying() || (player[0].getDuration() > 0 && player[1].getDuration() == 0)){
         nextID = 1;
      }
      player[nextID].load(track);
   }
   function addFiles(files){
      var nextID = 0,
          count = fileStore.push.apply(fileStore,files);
      const src = URL.createObjectURL(files[0]);
      if(player[0].isPlaying() || (player[0].getDuration() > 0 && player[1].getDuration() == 0)){
         nextID = 1;
      }
      player[nextID].load(src);
   }
   // New File selected
   fileSelector.addEventListener('change', (event) => {
  if(fileSelector.files.length > 0){
    addFiles(fileSelector.files);
  }
});
</script>
</html>